<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>stand.fm SNS投稿文メーカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      font-family: 'メイリオ', 'Hiragino Sans', sans-serif; 
      background: #f8f9fa; 
      padding: 2em;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.6;
    }
    .container {
      background: white;
      padding: 2em;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { 
      color: #333;
      margin-top: 0;
      text-align: center;
    }
    .form-group {
      margin-bottom: 1.5em;
    }
    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: bold;
      color: #555;
    }
    input[type="text"], 
    textarea {
      width: 100%;
      padding: 0.8em;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
      font-family: inherit;
    }
    input[type="text"] {
      height: 40px;
    }
    #postText { 
      height: 200px; 
      font-size: 1em; 
      resize: vertical;
    }
    .btn { 
      display: block;
      width: 100%;
      margin-top: 1.5em; 
      padding: 0.8em; 
      font-size: 1.1em; 
      border-radius: 6px; 
      background: #1da1f2; 
      color: #fff; 
      border: none; 
      cursor: pointer;
      transition: background 0.3s;
      text-align: center;
      text-decoration: none;
    }
    .btn:hover { 
      background: #0d8ddb; 
    }
    
    .clear-btn {
      background: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 6px;
      color: #666;
      cursor: pointer;
      font-size: 16px;
      height: 40px;
      line-height: 1;
      padding: 0 12px;
      transition: background 0.3s;
    }
    
    .clear-btn:hover {
      background: #e0e0e0;
    }
    .btn:active { 
      transform: translateY(1px);
    }
    #copiedMsg { 
      text-align: center;
      color: #1da1f2; 
      margin: 1em 0;
      font-weight: bold; 
      display: none;
    }
    .example {
      font-size: 0.85em;
      color: #666;
      margin-top: 0.3em;
      font-style: italic;
    }
    @media (max-width: 600px) {
      body {
        padding: 1em;
      }
      .container {
        padding: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>stand.fm SNS投稿文メーカー</h2>
    
    <div class="form-group">
      <label for="rssUrl">stand.fmのRSS URL</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="rssUrl" placeholder="例: https://stand.fm/rss/5ec4f43bf654bbcab4231d7f" style="flex: 1;">
        <button type="button" onclick="clearField('rssUrl')" class="clear-btn">×</button>
      </div>
      <div class="example">stand.fmの番組ページで「RSS」を右クリックしてURLをコピー</div>
    </div>

    <div class="form-group">
      <label for="applePodcastId">Apple Podcastの番組ID</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="applePodcastId" placeholder="例: 1821673136" style="flex: 1;">
        <button type="button" onclick="clearField('applePodcastId')" class="clear-btn">×</button>
      </div>
      <div class="example">Apple PodcastのURLの「id」の後の数字（例: https://podcasts.apple.com/jp/podcast/id1821673136 の場合「1821673136」）</div>
    </div>

    <div class="form-group">
      <label for="spotifyShowId">Spotifyの番組ID</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="spotifyShowId" placeholder="例: 6mDQ3s4QzXHsmDsro0sQ8e" style="flex: 1;">
        <button type="button" onclick="clearField('spotifyShowId')" class="clear-btn">×</button>
      </div>
      <div class="example">Spotifyの番組URLの「show/」の後の文字列（例: https://open.spotify.com/show/6mDQ3s4QzXHsmDsro0sQ8e の場合「6mDQ3s4QzXHsmDsro0sQ8e」）</div>
    </div>

    <div class="form-group">
      <label for="summary">サマリーテキスト</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="summary" placeholder="例: バイブコーディング中のトラブル体験と学びを共有。" style="flex: 1;">
        <button type="button" onclick="clearField('summary')" class="clear-btn">×</button>
      </div>
    </div>

    <div class="form-group">
      <label for="hashtags">ハッシュタグ</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="hashtags" placeholder="例: #バイブコーディング #AI活用 #生成AI #ちょっとai #ポッドキャスト" style="flex: 1;">
        <button type="button" onclick="clearField('hashtags')" class="clear-btn">×</button>
      </div>
    </div>

    <button class="btn" onclick="generatePost()">投稿文を生成</button>

    <div class="form-group" style="margin-top: 2em;">
      <label for="postText">生成された投稿文</label>
      <textarea id="postText" readonly></textarea>
    </div>

    <button class="btn" onclick="copyText()">投稿文をコピー</button>
    <div id="copiedMsg">コピーしました！</div>


  </div>

  <script>
    // 保存用のフィールドIDの配列
    const formFields = ['rssUrl', 'applePodcastId', 'spotifyShowId', 'summary', 'hashtags'];

    // フォームの値を保存
    function saveFormData() {
      formFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          localStorage.setItem(fieldId, element.value);
        }
      });
    }

    // ページ読み込み時に保存されたデータを復元
    document.addEventListener('DOMContentLoaded', function() {
      // ローカルストレージから値を復元
      formFields.forEach(fieldId => {
        const savedValue = localStorage.getItem(fieldId);
        const element = document.getElementById(fieldId);
        if (savedValue !== null && element) {
          element.value = savedValue;
        }
        // 入力イベントリスナーを追加
        element.addEventListener('input', saveFormData);
      });

      // URLパラメータをチェック（既存の機能を維持）
      const urlParams = new URLSearchParams(window.location.search);
      const rssUrl = urlParams.get('rss');
      const appleId = urlParams.get('appleId');
      
      if (rssUrl) {
        document.getElementById('rssUrl').value = rssUrl;
        saveFormData(); // URLパラメータで上書きした場合も保存
      }
      if (appleId) {
        document.getElementById('applePodcastId').value = appleId;
        saveFormData(); // URLパラメータで上書きした場合も保存
      }
      
      // パラメータがあれば自動で生成
      if (rssUrl && appleId) {
        generatePost();
      }
    });

    // タイトルからハッシュタグを自動生成
    function generateHashtags(title) {
      // よく使われるハッシュタグ
      const commonHashtags = ['#standfm', '#ポッドキャスト', '#podcast'];
      
      // タイトルからハッシュタグを生成
      // 1. 記号をスペースに置換
      // 2. 単語に分割（スペース、句読点、中黒で区切る）
      // 3. 1文字の単語を除外
      // 4. 数字のみの単語を除外
      // 5. ストップワードを除外
      // 6. 重複を削除
      // 7. 先頭の単語を取得（最大3つ）
      // 8. ハッシュタグに変換
      const hashtags = [...new Set(
        title
          .replace(/[【】『』「」()\[\]|・、,]/g, ' ')
          .split(/\s+/)
          .filter(word => word.length > 1)
          .filter(word => !/^\d+$/.test(word))
          .filter(word => !/^(の|に|は|を|が|と|で|も|へ|や|か|な|だ|です|ます|する|こと|ため|よう|たち|さん|ちゃん|くん|様|さま)$/.test(word))
      )]
        .slice(0, 3)
        .map(word => `#${word}`)
        .join(' ');
      
      // 共通のハッシュタグと結合
      return `${hashtags} ${commonHashtags.join(' ')}`.trim();
    }

    async function generatePost() {
      const rssUrl = document.getElementById('rssUrl').value.trim();
      const applePodcastId = document.getElementById('applePodcastId').value.trim();
      const spotifyShowId = document.getElementById('spotifyShowId').value.trim();
      const summary = document.getElementById('summary').value.trim();
      const hashtags = document.getElementById('hashtags').value.trim();
      const postText = document.getElementById('postText');
      const generateBtn = document.querySelector('button[onclick="generatePost()"]');

      if (!rssUrl) {
        alert('stand.fmのRSS URLを入力してください');
        return;
      }

      if (!applePodcastId) {
        alert('Apple Podcastの番組IDを入力してください');
        return;
      }

      // ボタンを無効化
      generateBtn.disabled = true;
      generateBtn.textContent = '取得中...';
      generateBtn.style.opacity = '0.7';
      postText.placeholder = 'エピソード情報を取得中...';

      try {
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error('RSSの取得に失敗しました');
        }
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "application/xml");
        const errorNode = doc.querySelector('parsererror');
        
        if (errorNode) {
          throw new Error('RSSの解析に失敗しました');
        }
        
        const item = doc.querySelector("item");
        if (!item) {
          throw new Error('有効なエピソードが見つかりませんでした');
        }
        
        const title = item.querySelector("title").textContent;
        const link = item.querySelector("link").textContent;
        const id = link.split('/').pop();
        const appleUrl = `https://podcasts.apple.com/jp/podcast/id${applePodcastId}?i=${id}`;
        const spotifyUrl = spotifyShowId ? `https://open.spotify.com/episode/${id}?si=${spotifyShowId}` : '';
        
        let post = `${title}\n\nstand.fm↓\n${link}`;
        
        if (applePodcastId) {
          post += `\nApple Podcast↓\n${appleUrl}`;
        }
        
        if (spotifyShowId) {
          post += `\nSpotify↓\n${spotifyUrl}`;
        }
        
        // 現在のサマリーとハッシュタグを取得（自動生成されたものも含む）
        const currentSummary = document.getElementById('summary').value.trim();
        const currentHashtags = document.getElementById('hashtags').value.trim();
        
        // 投稿文に追加
        if (currentSummary) {
          post += `\n\n${currentSummary}`;
        }
        if (currentHashtags) {
          post += currentSummary ? `\n${currentHashtags}` : `\n\n${currentHashtags}`;
        }
        
        postText.value = post;
        
        // ハッシュタグが空の場合、自動生成
        const hashtagsField = document.getElementById('hashtags');
        
        if (!hashtagsField.value.trim() && title) {
          const hashtags = generateHashtags(title);
          hashtagsField.value = hashtags;
          // ローカルストレージに保存
          saveFormData();
        }
        
        // コピーボタンを有効化
        document.querySelector('button[onclick="copyText()"]').style.display = 'block';
        
      } catch (error) {
        console.error('エラーが発生しました:', error);
        postText.value = '';
        postText.placeholder = `エラー: ${error.message}`;
      } finally {
        // ボタンを元に戻す
        generateBtn.disabled = false;
        generateBtn.textContent = '投稿文を生成';
        generateBtn.style.opacity = '1';
      }
    }

    function clearField(fieldId) {
      document.getElementById(fieldId).value = '';
      localStorage.removeItem(fieldId); // ローカルストレージからも削除
    }

    function copyText() {
      const textArea = document.getElementById('postText');
      if (!textArea.value) {
        alert('先に投稿文を生成してください');
        return;
      }
      
      textArea.select();
      document.execCommand('copy');
      
      const copiedMsg = document.getElementById('copiedMsg');
      copiedMsg.style.display = 'block';
      setTimeout(() => { 
        copiedMsg.style.display = 'none'; 
      }, 2000);
    }
  </script>
</body>
</html>