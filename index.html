<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>stand.fm SNS投稿文メーカー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      font-family: 'メイリオ', 'Hiragino Sans', sans-serif; 
      background: #f8f9fa; 
      padding: 2em;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.6;
    }
    .container {
      background: white;
      padding: 2em;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { 
      color: #333;
      margin-top: 0;
      text-align: center;
    }
    .form-group {
      margin-bottom: 1.5em;
    }
    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: bold;
      color: #555;
    }
    input[type="text"], 
    textarea {
      width: 100%;
      padding: 0.8em;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
      font-family: inherit;
    }
    input[type="text"] {
      height: 40px;
    }
    #postText { 
      height: 200px; 
      font-size: 1em; 
      resize: vertical;
    }
    .btn { 
      display: block;
      width: 100%;
      margin-top: 1.5em; 
      padding: 0.8em; 
      font-size: 1.1em; 
      border-radius: 6px; 
      background: #1da1f2; 
      color: #fff; 
      border: none; 
      cursor: pointer;
      transition: background 0.3s;
      text-align: center;
      text-decoration: none;
    }
    .btn:hover { 
      background: #0d8ddb; 
    }
    
    .clear-btn {
      background: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 6px;
      color: #666;
      cursor: pointer;
      font-size: 16px;
      height: 40px;
      line-height: 1;
      padding: 0 12px;
      transition: background 0.3s;
    }
    
    .clear-btn:hover {
      background: #e0e0e0;
    }
    .btn:active { 
      transform: translateY(1px);
    }
    #copiedMsg { 
      text-align: center;
      color: #1da1f2; 
      margin: 1em 0;
      font-weight: bold; 
      display: none;
    }
    .example {
      font-size: 0.85em;
      color: #666;
      margin-top: 0.3em;
      font-style: italic;
    }
    @media (max-width: 600px) {
      body {
        padding: 1em;
      }
      .container {
        padding: 1em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>stand.fm SNS投稿文メーカー</h2>
    
    <div class="form-group">
      <label for="rssUrl">stand.fmのRSS URL</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="rssUrl" placeholder="例: https://stand.fm/rss/5ec4f43bf654bbcab4231d7f" style="flex: 1;">
        <button type="button" onclick="clearField('rssUrl')" class="clear-btn">×</button>
      </div>
      <div class="example">stand.fmの番組ページで「RSS」を右クリックしてURLをコピー</div>
    </div>

    <div class="form-group">
      <label for="applePodcastId">Apple Podcastの番組ID</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="applePodcastId" placeholder="例: 1821673136" style="flex: 1;">
        <button type="button" onclick="clearField('applePodcastId')" class="clear-btn">×</button>
      </div>
      <div class="example">Apple PodcastのURLの「id」の後の数字（例: https://podcasts.apple.com/jp/podcast/id1821673136 の場合「1821673136」）</div>
    </div>

    <div class="form-group">
      <label for="spotifyShowId">Spotifyの番組ID</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="spotifyShowId" placeholder="例: 6mDQ3s4QzXHsmDsro0sQ8e" style="flex: 1;">
        <button type="button" onclick="clearField('spotifyShowId')" class="clear-btn">×</button>
      </div>
      <div class="example">Spotifyの番組URLの「show/」の後の文字列（例: https://open.spotify.com/show/6mDQ3s4QzXHsmDsro0sQ8e の場合「6mDQ3s4QzXHsmDsro0sQ8e」）</div>
    </div>

    <div class="form-group">
      <label for="hashtags">ハッシュタグ</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="hashtags" placeholder="例: #バイブコーディング #AI活用 #生成AI #ちょっとai #ポッドキャスト" style="flex: 1;">
        <button type="button" onclick="clearField('hashtags')" class="clear-btn">×</button>
      </div>
    </div>

    <button class="btn" onclick="generatePost()">投稿文を生成</button>

    <div class="form-group" style="margin-top: 2em;">
      <label for="postText">生成された投稿文</label>
      <textarea id="postText" readonly></textarea>
    </div>

    <button class="btn" onclick="copyText()">投稿文をコピー</button>
    <div id="copiedMsg">コピーしました！</div>


  </div>

  <script>
    // 保存用のフィールドIDの配列
    const formFields = ['rssUrl', 'applePodcastId', 'spotifyShowId', 'hashtags'];
    
    // 古いサマリーデータを削除
    if (localStorage.getItem('summary')) {
      localStorage.removeItem('summary');
    }

    // フォームの値を保存
    function saveFormData() {
      formFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
          localStorage.setItem(fieldId, element.value);
        }
      });
    }

    // ページ読み込み時に保存されたデータを復元
    document.addEventListener('DOMContentLoaded', function() {
      // ローカルストレージから値を復元
      formFields.forEach(fieldId => {
        const savedValue = localStorage.getItem(fieldId);
        const element = document.getElementById(fieldId);
        if (savedValue !== null && element) {
          element.value = savedValue;
        }
        // 入力イベントリスナーを追加
        element.addEventListener('input', saveFormData);
      });

      // URLパラメータをチェック（既存の機能を維持）
      const urlParams = new URLSearchParams(window.location.search);
      const rssUrl = urlParams.get('rss');
      const appleId = urlParams.get('appleId');
      
      if (rssUrl) {
        document.getElementById('rssUrl').value = rssUrl;
        saveFormData(); // URLパラメータで上書きした場合も保存
      }
      if (appleId) {
        document.getElementById('applePodcastId').value = appleId;
        saveFormData(); // URLパラメータで上書きした場合も保存
      }
      
      // パラメータがあれば自動で生成
      if (rssUrl && appleId) {
        generatePost();
      }
    });

    // タイトルからハッシュタグを自動生成
    function generateHashtags(title) {
      // よく使われるハッシュタグ
      const commonHashtags = ['#standfm', '#ポッドキャスト', '#podcast'];
      
      // 1. 先頭の番号を完全に削除（「#61」や「61.」など）
      const cleanTitle = title.replace(/^\s*[#＃]?\d+[\.\s]*/, '').trim();
      
      // 2. 記号を削除して単語に分割
      const words = cleanTitle
        .replace(/[【】『』「」()\[\]|・、,]/g, ' ')  // 記号をスペースに
        .split(/\s+/)  // 1つ以上の連続する空白で分割
        .filter(word => word.length > 0 && !/^[#＃]/.test(word));  // 空と既に#が付いているものを除外
      
      // 3. ユニークなハッシュタグのセットを作成
      const hashtagSet = new Set();
      
      // 4. タイトルから生成したハッシュタグを追加
      words.forEach(word => {
        if (!/^[#＃]/.test(word)) {  // まだ#が付いていない場合のみ追加
          hashtagSet.add(`#${word}`);
        }
      });
      
      // 5. 共通のハッシュタグを追加（重複しないように）
      commonHashtags.forEach(tag => hashtagSet.add(tag));
      
      // 6. 配列に変換してスペースで結合
      return Array.from(hashtagSet).join(' ');
    }

    async function generatePost() {
      const rssUrl = document.getElementById('rssUrl').value.trim();
      const applePodcastId = document.getElementById('applePodcastId').value.trim();
      const spotifyShowId = document.getElementById('spotifyShowId').value.trim();
      const hashtags = document.getElementById('hashtags').value.trim();
      const postText = document.getElementById('postText');
      const generateBtn = document.querySelector('button[onclick="generatePost()"]');

      if (!rssUrl) {
        alert('stand.fmのRSS URLを入力してください');
        return;
      }

      if (!applePodcastId) {
        alert('Apple Podcastの番組IDを入力してください');
        return;
      }

      // ボタンを無効化
      generateBtn.disabled = true;
      generateBtn.textContent = '取得中...';
      generateBtn.style.opacity = '0.7';
      postText.placeholder = 'エピソード情報を取得中...';

      try {
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error('RSSの取得に失敗しました');
        }
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "application/xml");
        const errorNode = doc.querySelector('parsererror');
        
        if (errorNode) {
          throw new Error('RSSの解析に失敗しました');
        }
        
        const item = doc.querySelector("item");
        if (!item) {
          throw new Error('有効なエピソードが見つかりませんでした');
        }
        
        const title = item.querySelector("title").textContent;
        const link = item.querySelector("link").textContent;
        const id = link.split('/').pop();
        const appleUrl = `https://podcasts.apple.com/jp/podcast/id${applePodcastId}?i=${id}`;
        const spotifyUrl = spotifyShowId ? `https://open.spotify.com/episode/${id}?si=${spotifyShowId}` : '';
        
        let post = `${title}\n\nstand.fm↓\n${link}`;
        
        if (applePodcastId) {
          post += `\nApple Podcast↓\n${appleUrl}`;
        }
        
        if (spotifyShowId) {
          post += `\nSpotify↓\n${spotifyUrl}`;
        }
        
        // ハッシュタグを取得して投稿文に追加
        const currentHashtags = document.getElementById('hashtags').value.trim();
        if (currentHashtags) {
          post += `\n\n${currentHashtags}`;
        }
        
        postText.value = post;
        
        // ハッシュタグが空の場合、自動生成
        const hashtagsField = document.getElementById('hashtags');
        if (!hashtagsField.value.trim() && title) {
          const hashtags = generateHashtags(title);
          hashtagsField.value = hashtags;
          // ローカルストレージに保存
          saveFormData();
        }
        
        // コピーボタンを有効化
        document.querySelector('button[onclick="copyText()"]').style.display = 'block';
        
      } catch (error) {
        console.error('エラーが発生しました:', error);
        postText.value = '';
        postText.placeholder = `エラー: ${error.message}`;
      } finally {
        // ボタンを元に戻す
        generateBtn.disabled = false;
        generateBtn.textContent = '投稿文を生成';
        generateBtn.style.opacity = '1';
      }
    }

    function clearField(fieldId) {
      document.getElementById(fieldId).value = '';
      localStorage.removeItem(fieldId); // ローカルストレージからも削除
    }

    function copyText() {
      const textArea = document.getElementById('postText');
      if (!textArea.value) {
        alert('先に投稿文を生成してください');
        return;
      }
      
      textArea.select();
      document.execCommand('copy');
      
      const copiedMsg = document.getElementById('copiedMsg');
      copiedMsg.style.display = 'block';
      setTimeout(() => { 
        copiedMsg.style.display = 'none'; 
      }, 2000);
    }
  </script>
</body>
</html>